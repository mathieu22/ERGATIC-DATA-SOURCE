services:
  postgres:
    image: postgres:16-alpine
    container_name: pappers_db
    restart: unless-stopped
    user: root
    environment:
      POSTGRES_DB: sirene
      POSTGRES_USER: pappers
      POSTGRES_PASSWORD: pappers_secure_2024
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=fr_FR.UTF-8"
    ports:
      - "5433:5432"
    volumes:
      - "/Volumes/Crucial X10/pappers_data/postgres:/var/lib/postgresql/data"
      - "./docs/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql"
    entrypoint:
      - /bin/sh
      - -c
      - |
        # Nettoyer les fichiers AppleDouble macOS
        find /var/lib/postgresql/data -name '._*' -delete 2>/dev/null || true
        # Corriger les permissions
        chown -R postgres:postgres /var/lib/postgresql/data 2>/dev/null || true
        # Lancer PostgreSQL normalement
        exec su-exec postgres docker-entrypoint.sh postgres \
          -c shared_buffers=2GB \
          -c effective_cache_size=6GB \
          -c maintenance_work_mem=1GB \
          -c work_mem=256MB \
          -c max_wal_size=4GB \
          -c checkpoint_completion_target=0.9 \
          -c wal_buffers=64MB \
          -c max_parallel_workers_per_gather=4 \
          -c max_parallel_workers=8 \
          -c log_statement=none
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pappers -d sirene"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PgAdmin pour visualiser les donn√©es (optionnel)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pappers_pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@pappers.local
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_SERVER_MODE: "False"
    ports:
      - "5050:80"
    volumes:
      - "/Volumes/Crucial X10/pappers_data/pgadmin:/var/lib/pgadmin"
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  postgres_data:
    driver: local
